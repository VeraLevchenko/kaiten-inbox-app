"""
Kaiten Inbox App - Backend
FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –ø–∏—Å–µ–º
–≠–¢–ê–ü 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∞–ª—å–Ω—ã–º API Kaiten
"""

from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import FileResponse
from pydantic import BaseModel
from typing import Optional, List
import os
from pathlib import Path
from dotenv import load_dotenv

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º KaitenClient
from kaiten_client import get_kaiten_client

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FastAPI
app = FastAPI(title="Kaiten Inbox API", version="1.0.0")

# CORS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å React frontend
cors_origins = os.getenv("CORS_ORIGINS", "http://localhost:3000").split(",")
app.add_middleware(
    CORSMiddleware,
    allow_origins=cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ .env
FILES_ROOT = Path(os.getenv("FILES_ROOT", "../samples"))

# ============================================================================
# –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
# ============================================================================

class FileInfo(BaseModel):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ –ø–∏—Å—å–º–∞"""
    name: str
    url: str
    ext: str

class CurrentCard(BaseModel):
    """–¢–µ–∫—É—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
    card_id: int
    title: str
    incoming_no: int
    files: List[FileInfo]

class AppState(BaseModel):
    """–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    queue_count: int
    deferred_count: int
    assigned_session_count: int
    current_card: Optional[CurrentCard]

class AssignRequest(BaseModel):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"""
    card_id: int
    owner_id: int
    co_owner_ids: List[int] = []
    comment_text: str = ""
    multi: bool = False

class SkipRequest(BaseModel):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–ø—É—Å–∫ –ø–∏—Å—å–º–∞"""
    card_id: int

# ============================================================================
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# ============================================================================

def get_files_for_card(incoming_no: int) -> List[FileInfo]:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –≤—Ö–æ–¥—è—â–µ–º—É –Ω–æ–º–µ—Ä—É
    
    Args:
        incoming_no: –í—Ö–æ–¥—è—â–∏–π –Ω–æ–º–µ—Ä –ø–∏—Å—å–º–∞
        
    Returns:
        List[FileInfo]: –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
    """
    # –ù–∞ –≠–¢–ê–ü–ï 3 –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–∑ samples
    # –ù–∞ –≠–¢–ê–ü–ï 4 –±—É–¥–µ–º –∏—Å–∫–∞—Ç—å —Ñ–∞–π–ª—ã –≤ FILES_ROOT/{incoming_no}/
    
    files = []
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
    test_files = [
        ("sample_letter.txt", "txt"),
        ("test_document.html", "html"),
    ]
    
    for filename, ext in test_files:
        file_path = FILES_ROOT / filename
        if file_path.exists():
            files.append(FileInfo(
                name=filename,
                url=f"/files/{incoming_no}/{filename}",
                ext=ext
            ))
    
    return files

def build_app_state() -> AppState:
    """
    –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kaiten
    
    Returns:
        AppState: –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    """
    client = get_kaiten_client()
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏ —Å –≤—Ö–æ–¥—è—â–∏–º –Ω–æ–º–µ—Ä–æ–º
    queue_cards = client.get_queue_cards_with_incoming_no()
    
    # –°—á—ë—Ç—á–∏–∫–∏ (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã deferred –∏ assigned)
    queue_count = len(queue_cards)
    deferred_count = 0  # TODO: –≠–¢–ê–ü 6
    assigned_session_count = 0  # TODO: –≠–¢–ê–ü 5
    
    # –¢–µ–∫—É—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ = –ø–µ—Ä–≤–∞—è –≤ –æ—á–µ—Ä–µ–¥–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π incoming_no)
    current_card = None
    if queue_cards:
        first_card = queue_cards[0]
        incoming_no = first_card["_incoming_no"]
        
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
        files = get_files_for_card(incoming_no)
        
        current_card = CurrentCard(
            card_id=first_card["id"],
            title=first_card["title"],
            incoming_no=incoming_no,
            files=files
        )
    
    return AppState(
        queue_count=queue_count,
        deferred_count=deferred_count,
        assigned_session_count=assigned_session_count,
        current_card=current_card
    )

# ============================================================================
# API Endpoints
# ============================================================================

@app.get("/")
async def root():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ API"""
    return {
        "app": "Kaiten Inbox API",
        "version": "1.0.0 - –≠–¢–ê–ü 3",
        "status": "running",
        "endpoints": {
            "state": "/api/state",
            "assign": "/api/assign",
            "skip": "/api/skip",
            "undo": "/api/undo",
            "files": "/files/{incoming_no}/{filename}"
        },
        "kaiten_connected": True
    }

@app.get("/api/state", response_model=AppState)
async def get_state():
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏
    –≠–¢–ê–ü 3: –ß–∏—Ç–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Kaiten API
    
    Returns:
        AppState: –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –æ—á–µ—Ä–µ–¥—å—é, —Å—á–µ—Ç—á–∏–∫–∞–º–∏ –∏ —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–æ–π
    """
    try:
        state = build_app_state()
        return state
    except Exception as e:
        print(f"[ERROR] Failed to build app state: {e}")
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        return AppState(
            queue_count=0,
            deferred_count=0,
            assigned_session_count=0,
            current_card=None
        )

@app.post("/api/assign", response_model=AppState)
async def assign_card(request: AssignRequest):
    """
    –ù–∞–∑–Ω–∞—á–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É
    –≠–¢–ê–ü 3: –ü–æ–∫–∞ –º–æ–∫–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, —Ä–µ–∞–ª—å–Ω–∞—è –±—É–¥–µ—Ç –Ω–∞ –≠–¢–ê–ü–ï 5
    
    Args:
        request: –î–∞–Ω–Ω—ã–µ –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏
        
    Returns:
        AppState: –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    # –ù–∞ –≠–¢–ê–ü–ï 3 –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –Ω–∞ –≠–¢–ê–ü–ï 5
    print(f"[TODO –≠–¢–ê–ü 5] Assign card {request.card_id} to user {request.owner_id}")
    if request.comment_text:
        print(f"[TODO –≠–¢–ê–ü 6] Comment: {request.comment_text}")
    if request.co_owner_ids:
        print(f"[TODO –≠–¢–ê–ü 7] Co-owners: {request.co_owner_ids}")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    return build_app_state()

@app.post("/api/skip", response_model=AppState)
async def skip_card(request: SkipRequest):
    """
    –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É (Skip)
    –≠–¢–ê–ü 3: –ü–æ–∫–∞ –º–æ–∫–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, —Ä–µ–∞–ª—å–Ω–∞—è –±—É–¥–µ—Ç –ø–æ–∑–∂–µ
    
    Args:
        request: ID –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞
        
    Returns:
        AppState: –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    # –ù–∞ –≠–¢–ê–ü–ï 3 –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
    print(f"[TODO] Skip card {request.card_id}")
    return build_app_state()

@app.post("/api/undo", response_model=AppState)
async def undo_last_action():
    """
    –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    –≠–¢–ê–ü 3: –ü–æ–∫–∞ –º–æ–∫–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
    
    Returns:
        AppState: –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    # –ù–∞ –≠–¢–ê–ü–ï 3 –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
    print(f"[TODO] Undo last action")
    return build_app_state()

@app.get("/files/{incoming_no}/{filename}")
async def get_file(incoming_no: int, filename: str):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª –ø–∏—Å—å–º–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    
    Args:
        incoming_no: –í—Ö–æ–¥—è—â–∏–π –Ω–æ–º–µ—Ä –ø–∏—Å—å–º–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–∫–∞)
        filename: –ò–º—è —Ñ–∞–π–ª–∞
        
    Returns:
        FileResponse: –§–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    """
    import mimetypes
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç path traversal
    if ".." in filename or "/" in filename or "\\" in filename:
        raise HTTPException(status_code=400, detail="Invalid filename")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    # –ù–∞ –≠–¢–ê–ü–ï 3 –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–ø–∫—É samples –Ω–∞–ø—Ä—è–º—É—é
    # –ù–∞ –≠–¢–ê–ü–ï 4 –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FILES_ROOT/{incoming_no}/
    file_path = FILES_ROOT / filename
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    if not file_path.exists() or not file_path.is_file():
        raise HTTPException(status_code=404, detail=f"File not found: {filename}")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø
    mime_type, _ = mimetypes.guess_type(filename)
    if mime_type is None:
        mime_type = "application/octet-stream"
    
    print(f"[DEBUG] Serving file: {filename}, MIME: {mime_type}")
    
    # –û—Ç–¥–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (inline), –∞ –Ω–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    return FileResponse(
        path=str(file_path),
        media_type=mime_type,
        headers={
            "Content-Disposition": f"inline; filename=\"{filename}\""
        }
    )

# ============================================================================
# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# ============================================================================

if __name__ == "__main__":
    import uvicorn
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ .env
    host = os.getenv("BACKEND_HOST", "0.0.0.0")
    port = int(os.getenv("BACKEND_PORT", "8000"))
    
    print(f"üöÄ Starting Kaiten Inbox Backend (–≠–¢–ê–ü 3)")
    print(f"üìç Server: http://{host}:{port}")
    print(f"üìö Docs: http://{host}:{port}/docs")
    
    uvicorn.run(
        "main:app",
        host=host,
        port=port,
        reload=True
    )